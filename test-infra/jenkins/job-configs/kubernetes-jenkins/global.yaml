- builder:
    name: activate-gce-service-account
    builders:
      - shell: |
          export HOME="${WORKSPACE}"
          export CLOUDSDK_CONFIG="${WORKSPACE}/.config/gcloud"
          gcloud auth activate-service-account --key-file="${GOOGLE_APPLICATION_CREDENTIALS}"

- publisher:
    name: gcs-uploader
    publishers:
        - postbuildscript:
            builders:
                - shell: |
                    mkdir -p _tmp
                    curl -fsS --retry 3 "https://raw.githubusercontent.com/kubernetes/kubernetes/master/hack/jenkins/upload-to-gcs.sh" > ./_tmp/upload-to-gcs.sh
                    chmod +x ./_tmp/upload-to-gcs.sh
                    # TODO(euank): our jenkins master is not available to workers so easily so the below fails
                    curl -fsS --retry 3 "http://jenkins-master:8080/job/${JOB_NAME}/${BUILD_NUMBER}/consoleText" > "${WORKSPACE}/build-log.txt" || true
                - conditional-step:
                    condition-kind: current-status
                    condition-worst: SUCCESS
                    condition-best: SUCCESS
                    steps:
                        - shell: |
                            export CLOUDSDK_CONFIG="${WORKSPACE}/.config/gcloud"
                            export HOME="${WORKSPACE}"
                            export JENKINS_BUILD_FINISHED=SUCCESS
                            ./_tmp/upload-to-gcs.sh
                - conditional-step:
                    condition-kind: current-status
                    condition-worst: UNSTABLE
                    condition-best: UNSTABLE
                    steps:
                        - shell: |
                            export CLOUDSDK_CONFIG="${WORKSPACE}/.config/gcloud"
                            export HOME="${WORKSPACE}"
                            export JENKINS_BUILD_FINISHED=UNSTABLE
                            ./_tmp/upload-to-gcs.sh
                - conditional-step:
                    condition-kind: current-status
                    condition-worst: FAILURE
                    condition-best: FAILURE
                    steps:
                        - shell: |
                            export CLOUDSDK_CONFIG="${WORKSPACE}/.config/gcloud"
                            export HOME="${WORKSPACE}"
                            export JENKINS_BUILD_FINISHED=FAILURE
                            ./_tmp/upload-to-gcs.sh
                - conditional-step:
                    condition-kind: current-status
                    condition-worst: ABORTED
                    condition-best: ABORTED
                    steps:
                        - shell: |
                            export CLOUDSDK_CONFIG="${WORKSPACE}/.config/gcloud"
                            export HOME="${WORKSPACE}"
                            export JENKINS_BUILD_FINISHED=ABORTED
                            ./_tmp/upload-to-gcs.sh
            script-only-if-succeeded: False
            script-only-if-failed: False
